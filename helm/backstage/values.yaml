backstage:
  backstage:
    containerPorts:
      backend: 7007

    extraEnvVarsSecrets:
      - backstage-secrets
      - backstage-postgresql

    appConfig:
      app:
        title: Backstage
        baseUrl: ${APP_BASE_URL}
        support:
          url: ${APP_BASE_URL}
          items:
            - title: Documentation
              icon: docs
              links:
                - url: https://backstage.io/docs
                  title: Backstage Documentation
            - title: Support
              icon: help
              links:
                - url: https://github.com/backstage/backstage/issues
                  title: GitHub Issues

      organization:
        name: ${ORGANIZATION_NAME}

      backend:
        baseUrl: ${BACKEND_BASE_URL}
        listen:
          port: 7007
        auth:
          externalAccess:
            - type: legacy
              options:
                subject: legacy-default-config
                secret: ${AUTH_SECRET}
        cors:
          origin: ${APP_BASE_URL}
          methods: [GET, HEAD, PATCH, POST, PUT, DELETE]
          credentials: true
        csp:
          connect-src: ["'self'", 'http:', 'https:']
        database:
          client: pg
          connection:
            host: ${POSTGRES_HOST}
            port: ${POSTGRES_PORT}
            user: ${POSTGRES_USER}
            password: ${POSTGRES_PASSWORD}

      auth:
        environment: production
        providers:
          github:
            production:
              clientId: ${AUTH_GITHUB_CLIENT_ID}
              clientSecret: ${AUTH_GITHUB_CLIENT_SECRET}
              callbackUrl: ${BACKEND_BASE_URL}/api/auth/github/handler/frame
              signIn:
                resolvers:
                  - resolver: usernameMatchingUserEntityName
          guest:
            dangerouslyAllowOutsideDevelopment: true
          gitlab:
            production:
              clientId: ${AUTH_GITLAB_CLIENT_ID}
              clientSecret: ${AUTH_GITLAB_CLIENT_SECRET}
              callbackUrl: ${BACKEND_BASE_URL}/api/auth/gitlab/handler/frame
              apiBaseUrl: ${GITLAB_API_BASE_URL}
              baseUrl: ${GITLAB_BASE_URL}
              signIn:
                resolvers:
                  - resolver: usernameMatchingUserEntityName

      signInPage: github

      integrations:
        github:
          - host: github.com
            token: ${GITHUB_TOKEN}


      catalog:
        locations:
          - type: url
            target: https://raw.githubusercontent.com/itgix/adp-backstage-scaffold/main/argo-helm-templates/bckstg-scaf-templ-argocd-app-github.yaml
            rules:
              - allow: [Template]
          - type: url
            target: https://raw.githubusercontent.com/itgix/adp-backstage-scaffold/main/argo-helm-templates/bckstg-scaf-templ-argocd-app-gitlab.yaml
            rules:
              - allow: [Template]
          - type: file
            target: ./examples/org.yaml
            rules:
              - allow: [User, Group]
          - type: gitlab
            target: ${GITLAB_TARGET}
      scaffolder:
        defaultEnvironment:
          parameters:
            sampleStaticParam: "testValue"
          secrets:
            region: ${AWS_REGION}
            repoName: ${GIT_APP_REPO}
            repoOwner: ${GIT_APP_OWNER}


  postgresql:
    enabled: true
    auth:
      username: bn_backstage
      existingSecret: "backstage-postgresql"
      secretKeys:
        adminPasswordKey: postgres-password
        userPasswordKey: password

      providers:
        gitlab:
          gitlabId:
            host: ${GITLAB_HOST}
            apiBaseUrl: ${GITLAB_API_BASE_URL}
            token: ${GITLAB_TOKEN}
            orgEnabled: true
            groupPattern: '[\s\S]*'
            schedule:                 
              frequency: "1h"         
              timeout: "30s" 
